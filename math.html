<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Math Star Battle with Effects</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at center, #000010, #000000);
      color: #0ff;
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
      user-select: none;
    }
    #game {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    #header {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      display: flex;
      justify-content: space-between;
      font-size: 1.2rem;
      font-weight: 600;
    }
    #question {
      position: absolute;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.8rem;
      padding: 8px 16px;
      background: rgba(0,255,255,0.15);
      border: 2px solid #0ff;
      border-radius: 12px;
    }
    #answersContainer {
      position: absolute;
      top: 120px;
      left: 10px;
      right: 10px;
      bottom: 160px;
      overflow: hidden;
    }
    .answerBubble {
      position: absolute;
      width: 70px; height: 70px;
      background: linear-gradient(135deg, #7ef9ff, #00fff7);
      clip-path: polygon(
        50% 0%, 61% 35%, 98% 35%, 68% 57%,
        79% 91%, 50% 70%, 21% 91%, 32% 57%,
        2% 35%, 39% 35%
      );
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.4rem;
      color: #00444d;
      text-shadow: 0 0 6px #00fff7;
      cursor: pointer;
      transition: transform 0.2s ease;
      user-select: none;
    }
    .answerBubble:hover {
      transform: scale(1.1);
      box-shadow: 0 0 12px #00fff7;
    }
    #ship {
      position: absolute;
      bottom: 20px;
      width: 60px; height: 60px;
      left: 50%;
      transform: translateX(-50%);
      transition: left 0.2s ease;
      user-select: none;
    }
    #ship svg polygon {
      fill: #ffd700;
      filter: drop-shadow(0 0 6px #ffdd55);
    }
    .projectile {
      position: absolute;
      width: 40px; height: 40px;
      background: linear-gradient(135deg, #fffc33, #f7d64e);
      clip-path: polygon(
        50% 0%, 61% 35%, 98% 35%, 68% 57%,
        79% 91%, 50% 70%, 21% 91%, 32% 57%,
        2% 35%, 39% 35%
      );
      box-shadow: 0 0 15px #fff850;
      filter: drop-shadow(0 0 8px #fff850);
      pointer-events: none;
      user-select: none;
      z-index: 100;
    }
    .burstEffect {
      position: absolute;
      pointer-events: none;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0) 70%);
      width: 20px; height: 20px;
      transform: scale(0);
      opacity: 1;
      animation: burstAnim 0.6s ease-out forwards;
      z-index: 150;
    }
    @keyframes burstAnim {
      to {
        transform: scale(3);
        opacity: 0;
      }
    }
    #aiTutor {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(0,255,255,0.15);
      padding: 12px 18px 12px 60px;
      border-radius: 20px;
      color: #0ff;
      font-weight: 600;
      max-width: 300px;
      user-select: none;
      box-shadow: 0 0 15px #0ff;
    }
    #aiTutor .starOrb {
      position: absolute;
      left: 12px; top: 12px;
      width: 36px; height: 36px;
      background: linear-gradient(135deg, #7ef9ff, #00fff7);
      clip-path: polygon(
        50% 0%, 61% 35%, 98% 35%, 68% 57%,
        79% 91%, 50% 70%, 21% 91%, 32% 57%,
        2% 35%, 39% 35%
      );
      box-shadow: 0 0 20px #00fff7;
      filter: drop-shadow(0 0 10px #00fff7);
    }
  </style>
<body>
  <div id="game">
    <div id="header">
      <div id="score">Score: 0</div>
      <div id="timer">Time: 60</div>
    </div>
    <div id="question">Loading...</div>
    <div id="answersContainer"></div>
    <div id="ship">
      <svg viewBox="0 0 64 64" width="60" height="60" aria-hidden="true">
        <polygon points="32,4 39,24 60,24 42,38 49,58 32,44 15,58 22,38 4,24 25,24" />
      </svg>
    </div>
    <div id="aiTutor"><div class="starOrb"></div><div id="aiMessage">Get ready!</div></div>
  </div>

<script>
(() => {
  const scoreEl = document.getElementById('score');
  const timerEl = document.getElementById('timer');
  const questionEl = document.getElementById('question');
  const answersContainer = document.getElementById('answersContainer');
  const ship = document.getElementById('ship');
  const aiMessage = document.getElementById('aiMessage');

  let score = 0;
  let timeLeft = 60;
  let timerInterval = null;
  let currentAnswer = null;
  let answers = [];
  let floatPos = [];
  let floatDir = [];
  let shipIdx = 0;
  let projectile = null;
  let speed = 3;
  let wrongCount = 0;

  const tips = [
    "You're shining bright!",
    "Stay focused on the math star",
    "Quick and accurate wins!",
    "You can do it!"
  ];

  function randomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function updateScoreDisplay() {
    scoreEl.textContent = `Score: ${score}`;
  }
  function updateTimerDisplay() {
    timerEl.textContent = `Time: ${timeLeft}`;
  }

  function generateQA() {
    const diff = Math.min(10 + Math.floor(score / 10), 50);
    const a = randomInt(1, diff);
    const b = randomInt(1, diff);
    const answer = a + b;
    const question = `${a} + ${b}`;
    const arr = new Set([answer]);
    while (arr.size < 5) {
      let cand = answer + randomInt(-diff, diff);
      if (cand < 0) cand = 0;
      arr.add(cand);
    }
    const ansArr = Array.from(arr);
    for (let i = ansArr.length - 1; i > 0; i--) {
      const j = randomInt(0, i);
      [ansArr[i], ansArr[j]] = [ansArr[j], ansArr[i]];
    }
    return { question, ansArr, answer };
  }

  function setupAnswers() {
    answersContainer.innerHTML = '';
    answers = [];
    floatPos = [];
    floatDir = [];

    const { question, ansArr, answer } = generateQA();
    questionEl.textContent = question;
    currentAnswer = answer;

    const contRect = answersContainer.getBoundingClientRect();
    const w = answersContainer.clientWidth;
    const h = answersContainer.clientHeight;

    ansArr.forEach((val, i) => {
      const bubble = document.createElement('div');
      bubble.className = 'answerBubble';
      bubble.textContent = val;
      answersContainer.appendChild(bubble);
      answers.push({ el: bubble, val });

      const x = randomInt(10, w - 80);
      const y = randomInt(10, h - 80);
      floatPos.push({ x, y });
      floatDir.push({
        x: (Math.random() - 0.5) * 0.6,
        y: (Math.random() - 0.5) * 0.6
      });

      // Mobile / desktop tap listener
      bubble.addEventListener('click', () => {
        attemptHit(i);
      });
    });

    shipIdx = 0;
    positionShip();
  }

  function animateBubbles() {
    const w = answersContainer.clientWidth;
    const h = answersContainer.clientHeight;
    answers.forEach((ans, i) => {
      let pos = floatPos[i];
      let dir = floatDir[i];
      pos.x += dir.x;
      pos.y += dir.y;
      if (pos.x < 0 || pos.x > w - 80) dir.x = -dir.x;
      if (pos.y < 0 || pos.y > h - 80) dir.y = -dir.y;
      floatPos[i] = pos;
      floatDir[i] = dir;
      ans.el.style.left = pos.x + 'px';
      ans.el.style.top = pos.y + 'px';
    });
  }

  function positionShip() {
    if (answers.length === 0) return;
    const bubbleCenters = answers.map(a => {
      const r = a.el.getBoundingClientRect();
      const cont = answersContainer.getBoundingClientRect();
      return r.left + r.width/2 - cont.left;
    });
    if (shipIdx < 0) shipIdx = 0;
    if (shipIdx >= bubbleCenters.length) shipIdx = bubbleCenters.length -1;
    const x = bubbleCenters[shipIdx] - ship.clientWidth/2;
    ship.style.left = x + 'px';
  }

  function moveShip(dir) {
    shipIdx += dir;
    positionShip();
  }

  function fireProjectile() {
    attemptHit(shipIdx);
  }

  function attemptHit(idx) {
    if (projectile) return;

    const bubble = answers[idx];
    if (!bubble) return;

    const targetEl = bubble.el;
    const contRect = answersContainer.getBoundingClientRect();
    const tRect = targetEl.getBoundingClientRect();

    const targetX = tRect.left + tRect.width/2 - contRect.left - 20;
    const targetY = tRect.top + tRect.height/2 - contRect.top - 20;

    // Burst effect if correct
    if (bubble.val === currentAnswer) {
      // Show burst
      const burst = document.createElement('div');
      burst.className = 'burstEffect';
      answersContainer.appendChild(burst);
      burst.style.left = `${targetX}px`;
      burst.style.top = `${targetY}px`;

      // Remove burst after animation
      burst.addEventListener('animationend', () => {
        burst.remove();
      });

      score += 10 + speed * 2;
      setupAnswers();
      updateScoreDisplay();
      aiMessage.textContent = tips[randomInt(0, tips.length -1)];
    } else {
      wrongCount++;
      score = Math.max(0, score - 5);
      aiMessage.textContent = "❌ Oops, try again!";
      updateScoreDisplay();
    }
  }

  function startTimer() {
    clearInterval(timerInterval);
    timeLeft = 60;
    updateTimerDisplay();
    timerInterval = setInterval(() => {
      timeLeft--;
      updateTimerDisplay();
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        aiMessage.textContent = `Time’s up! Final score: ${score}`;
        window.removeEventListener('keydown', onKeyDown);
        window.removeEventListener('touchstart', onTouch);
      }
    }, 1000);
  }

  function onKeyDown(e) {
    if (e.key === 'ArrowLeft') moveShip(-1);
    else if (e.key === 'ArrowRight') moveShip(1);
    else if (e.key === ' ') {
      fireProjectile();
      e.preventDefault();
    }
  }

  function onTouch(e) {
    const touch = e.touches[0];
    const w = window.innerWidth;
    const h = window.innerHeight;
    if (touch.clientY > h * 0.6) {
      if (touch.clientX < w / 2) moveShip(-1);
      else moveShip(1);
    } else {
      fireProjectile();
    }
  }

  updateScoreDisplay();
  startTimer();
  setupAnswers();
  requestAnimationFrame(function loop(){
    animateBubbles();
    requestAnimationFrame(loop);
  });
  window.addEventListener('keydown', onKeyDown);
  window.addEventListener('touchstart', onTouch);
})();
</script>
</body>
</html>
