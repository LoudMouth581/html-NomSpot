<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Math Star Battle with AI Tutor</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap');
    body {
      margin: 0;
      background: radial-gradient(circle at center, #000010, #000000);
      font-family: 'Orbitron', monospace;
      color: #0ff;
      overflow-x: hidden;
      user-select: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      padding: 0 10px 20px;
    }
    #game {
      position: relative;
      width: 100%;
      max-width: 700px;
      height: 100%;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      box-sizing: border-box;
      padding: 10px 0;
    }

    /* Header with scoreboard and timer */
    #header {
      display: flex;
      justify-content: space-around;
      padding: 10px 15px;
      border: 2px solid #0ff;
      border-radius: 20px;
      background: #001122;
      box-shadow: 0 0 30px #0ff;
      font-size: 1.3rem;
      font-weight: 700;
      user-select: none;
      margin-bottom: 10px;
    }
    #scoreboard, #timer {
      flex: 1;
      text-align: center;
    }

    /* Question Billboard */
    #questionBillboard {
      margin: 0 auto 20px;
      background: #001122;
      border: 3px solid #0ff;
      border-radius: 30px;
      box-shadow: 0 0 35px #0ff;
      font-size: 2rem;
      font-weight: 700;
      padding: 15px 30px;
      max-width: 600px;
      text-align: center;
      min-height: 4rem;
      user-select: none;
    }

    /* Answers container â€” relative for floating stars */
    #answersContainer {
      position: relative;
      height: 250px;
      max-width: 600px;
      margin: 0 auto 30px;
      background: transparent;
      border-radius: 20px;
      overflow: visible;
      user-select: none;
    }

    /* Star bubble shape for answers */
    .answerBubble {
      position: absolute;
      width: 80px;
      height: 80px;
      background: linear-gradient(45deg, #00ffff, #006666);
      clip-path: polygon(
        50% 0%, 61% 35%, 98% 35%, 68% 57%,
        79% 91%, 50% 70%, 21% 91%, 32% 57%,
        2% 35%, 39% 35%
      );
      box-shadow: 0 0 18px #0ff;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.8rem;
      font-weight: 700;
      color: #002222;
      cursor: pointer;
      user-select: none;
      transition: transform 0.3s ease;
      z-index: 10;
      filter: drop-shadow(0 0 6px #00ffff);
    }
    .answerBubble:hover {
      transform: scale(1.3);
      box-shadow: 0 0 30px #0ff, 0 0 45px #0ff;
      color: #00ffff;
      z-index: 20;
    }

    /* Ship */
    #ship {
      position: relative;
      margin: 0 auto 25px;
      width: 60px;
      height: 60px;
      filter: drop-shadow(0 0 12px #0ff);
      cursor: pointer;
      user-select: none;
      transition: left 0.3s ease;
      left: 50%;
      transform: translateX(-50%);
      z-index: 15;
    }
    #ship svg {
      fill: #0ff;
      stroke: #0cc;
      stroke-width: 2;
    }

    /* Projectile star */
    .projectile {
      position: absolute;
      width: 40px;
      height: 40px;
      pointer-events: none;
      filter: drop-shadow(0 0 8px #ff0);
      animation: glowStar 1s infinite alternate;
      z-index: 30;
      user-select: none;
    }
    @keyframes glowStar {
      from { filter: drop-shadow(0 0 8px #ff0);}
      to { filter: drop-shadow(0 0 20px #ff0);}
    }

    /* Controls container */
    #controls {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .btn {
      background: #001122;
      border: 2px solid #0ff;
      border-radius: 14px;
      color: #0ff;
      font-weight: 700;
      font-size: 22px;
      padding: 12px 22px;
      cursor: pointer;
      transition: background 0.3s, color 0.3s;
      user-select: none;
      min-width: 58px;
      text-align: center;
      user-select:none;
    }
    .btn:hover {
      background: #0ff;
      color: #001122;
    }

    /* Speed slider as star */
    #speedControl {
      width: 160px;
      -webkit-appearance: none;
      background: transparent;
      margin: 0 15px;
      cursor: pointer;
      user-select:none;
    }
    #speedControl::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 40px;
      height: 40px;
      background: gold;
      clip-path: polygon(
        50% 0%, 61% 35%, 98% 35%, 68% 57%,
        79% 91%, 50% 70%, 21% 91%, 32% 57%,
        2% 35%, 39% 35%
      );
      cursor: pointer;
      box-shadow: 0 0 24px gold;
      transition: background 0.3s ease;
      user-select:none;
    }
    #speedControl::-webkit-slider-thumb:hover {
      background: #ffaa00;
    }
    #speedControl:focus {
      outline: none;
    }
    #speedControl::-moz-range-thumb {
      width: 40px;
      height: 40px;
      background: gold;
      clip-path: polygon(
        50% 0%, 61% 35%, 98% 35%, 68% 57%,
        79% 91%, 50% 70%, 21% 91%, 32% 57%,
        2% 35%, 39% 35%
      );
      cursor: pointer;
      box-shadow: 0 0 24px gold;
      user-select:none;
    }

    /* Mode selector */
    #modeSelector {
      margin: 15px auto 0;
      max-width: 600px;
      text-align: center;
      user-select:none;
    }
    #modeSelector label {
      margin: 0 18px;
      font-weight: 700;
      cursor: pointer;
      font-size: 1.3rem;
      user-select:none;
    }
    #modeSelector input {
      margin-right: 8px;
      cursor: pointer;
      user-select:none;
    }

    /* AI Tutor */
    #aiTutor {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #003344dd;
      border: 2px solid #0ff;
      border-radius: 40px;
      width: 280px;
      padding: 12px 20px 14px 80px;
      box-shadow: 0 0 30px #0ffcc;
      color: #0ff;
      font-weight: 700;
      font-size: 1rem;
      user-select:none;
      display: flex;
      align-items: center;
      z-index: 50;
      animation: fadeIn 1s ease forwards;
    }
    #aiTutor .starOrb {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 60px;
      height: 60px;
      background: radial-gradient(circle at center, #00ffff, #004466);
      clip-path: polygon(
        50% 0%, 61% 35%, 98% 35%, 68% 57%,
        79% 91%, 50% 70%, 21% 91%, 32% 57%,
        2% 35%, 39% 35%
      );
      box-shadow: 0 0 30px #0ff;
      filter: drop-shadow(0 0 15px #0ff);
      animation: pulseOrb 3s infinite ease-in-out;
      user-select:none;
    }
    @keyframes pulseOrb {
      0%, 100% { box-shadow: 0 0 30px #0ff; }
      50% { box-shadow: 0 0 50px #0ff; }
    }
    @keyframes fadeIn {
      from {opacity:0; transform: translateY(20px);}
      to {opacity:1; transform: translateY(0);}
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
      #answersContainer {
        height: 200px;
      }
      .answerBubble {
        width: 60px;
        height: 60px;
        font-size: 1.4rem;
      }
      #ship {
        width: 45px;
        height: 45px;
      }
      .btn {
        font-size: 18px;
        padding: 10px 16px;
      }
      #aiTutor {
        width: 90vw;
        bottom: 10px;
        right: 5vw;
        padding-left: 70px;
        font-size: 0.9rem;
      }
      #aiTutor .starOrb {
        width: 45px;
        height: 45px;
        left: 8px;
      }
    }
  </style>
</head>
<body>
  <div id="game" role="main" aria-label="Math Star Battle game">
    <header id="header" aria-live="polite" aria-atomic="true">
      <div id="scoreboard" aria-label="Current score">Score: 0</div>
      <div id="timer" aria-label="Time remaining">Time: 60</div>
    </header>

    <section id="questionBillboard" aria-live="polite" aria-atomic="true">Loading...</section>

    <section id="answersContainer" aria-label="Answer options" role="list" tabindex="0"></section>

    <div id="ship" role="img" aria-label="Your star shooter" tabindex="0" >
      <svg viewBox="0 0 64 64" width="60" height="60" aria-hidden="true" focusable="false">
        <polygon points="32 2 39 22 62 24 43 37 49 60 32 48 15 60 21 37 2 24 25 22" />
      </svg>
    </div>

    <div id="controls" aria-label="Game controls">
      <button class="btn" id="btnLeft" aria-label="Move left">&#8592;</button>
      <button class="btn" id="btnFire" aria-label="Fire projectile">&#9733;</button>
      <button class="btn" id="btnRight" aria-label="Move right">&#8594;</button>
      <input type="range" min="1" max="5" value="3" id="speedControl" aria-label="Projectile speed control" />
    </div>

    <form id="modeSelector" aria-label="Select game mode">
      <label><input type="radio" name="mode" value="addition" checked /> Addition Level</label>
      <label><input type="radio" name="mode" value="subtraction" /> Subtraction Level</label>
      <label><input type="radio" name="mode" value="opponent" /> Opponent Mode</label>
    </form>
  </div>

  <aside id="aiTutor" role="complementary" aria-live="polite" aria-atomic="true">
    <div class="starOrb" aria-hidden="true"></div>
    <div id="aiMessage">Let's warm up with some addition! Shoot the right star.</div>
  </aside>

<script>
(() => {
  const scoreboard = document.getElementById('scoreboard');
  const timerEl = document.getElementById('timer');
  const questionBillboard = document.getElementById('questionBillboard');
  const answersContainer = document.getElementById('answersContainer');
  const ship = document.getElementById('ship');
  const btnLeft = document.getElementById('btnLeft');
  const btnRight = document.getElementById('btnRight');
  const btnFire = document.getElementById('btnFire');
  const speedControl = document.getElementById('speedControl');
  const modeRadios = document.querySelectorAll('#modeSelector input[name="mode"]');
  const aiMessage = document.getElementById('aiMessage');

  const modes = {
    addition: '+',
    subtraction: '-',
    opponent: 'opponent'
  };

  let currentMode = 'addition';
  let speed = Number(speedControl.value);
  let score = 0;
  let timeLeft = 60;
  let timerInterval = null;
  let wrongCount = 0;

  let shipPosIndex = 0;
  let projectile = null;
  const projectileSpeedBase = 6;

  let answers = [];
  let currentAnswer = null;
  let currentQuestion = '';

  // Animation offsets and movement data for floating stars
  let floatDirections = [];
  let floatPositions = [];

  // For AI Tutor tips
  const tutorTips = {
    addition: [
      "Great start! Addition is the foundation.",
      "Try to shoot quickly for bonus points!",
      "Remember: adding zero doesn't change the number.",
      "Watch the stars and trust your instincts!"
    ],
    subtraction: [
      "Subtraction sharpens your math skills!",
      "Keep an eye on the smaller stars.",
      "Negative answers are tricky, but here we keep it positive.",
      "Youâ€™re doing great! Stay focused."
    ],
    opponent: [
      "This is tough â€” multiple operations coming your way!",
      "Use your math powers to outscore your opponent!",
      "Think fast! Time's ticking!",
      "Remember, every star counts!"
    ]
  };

  // Sounds - simple beeps using Web Audio API (no files)
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  function playBeep(freq = 440, duration = 150) {
    const osc = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    osc.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    osc.type = 'triangle';
    osc.frequency.value = freq;
    osc.start();
    gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
    osc.stop(audioCtx.currentTime + duration / 1000);
  }

  // Timer management
  function startTimer() {
    if(timerInterval) clearInterval(timerInterval);
    timeLeft = 60;
    updateTimerDisplay();
    timerInterval = setInterval(() => {
      timeLeft--;
      updateTimerDisplay();
      if(timeLeft <= 0) {
        clearInterval(timerInterval);
        gameOver();
      }
    }, 1000);
  }

  function updateTimerDisplay() {
    timerEl.textContent = `Time: ${timeLeft}`;
  }

  // Score update
  function updateScore() {
    scoreboard.textContent = `Score: ${score}`;
  }

  // Generate math question
  function generateQuestion() {
    let op = modes[currentMode];
    if(currentMode === 'opponent') {
      const ops = ['+', '-', '*', '/'];
      op = ops[Math.floor(Math.random() * ops.length)];
    }
    // Difficulty scaling based on score
    let difficulty = Math.min(10 + Math.floor(score / 5) * 5, 100);
    let a, b;

    if(op === '+' || op === '-') {
      a = Math.floor(Math.random() * difficulty) + 1;
      b = Math.floor(Math.random() * difficulty) + 1;
    } else if(op === '*') {
      a = Math.floor(Math.random() * (difficulty / 5)) + 1;
      b = Math.floor(Math.random() * (difficulty / 5)) + 1;
    } else if(op === '/') {
      b = Math.floor(Math.random() * (difficulty / 5)) + 1;
      a = b * (Math.floor(Math.random() * (difficulty / 5)) + 1);
    }

    let questionText = `${a} ${op} ${b}`;
    let answerVal = eval(questionText);
    if(op === '/') answerVal = Math.round(answerVal * 100) / 100; // max 2 decimals

    return { questionText, answerVal };
  }

  // Generate 5 answer options including correct answer and distractors
  function generateAnswers(correctVal) {
    const choices = new Set();
    choices.add(correctVal);

    while(choices.size < 5) {
      let delta = (Math.random() * 10) - 5;
      let distractor = correctVal + delta;
      if(typeof correctVal === 'number' && !Number.isInteger(correctVal)) {
        distractor = Math.round(distractor * 100) / 100;
      } else {
        distractor = Math.round(distractor);
      }
      if(distractor !== correctVal && distractor >= 0) {
        choices.add(distractor);
      }
    }

    return [...choices].sort(() => Math.random() - 0.5);
  }

  // Clear answers container and data
  function clearAnswers() {
    answersContainer.innerHTML = '';
    answers = [];
    floatDirections = [];
    floatPositions = [];
  }

  // Setup answers as moving star bubbles with random positions and float directions
  function setupAnswers() {
    clearAnswers();
    let generated = generateQuestion();
    currentQuestion = generated.questionText;
    currentAnswer = generated.answerVal;

    questionBillboard.textContent = currentQuestion;

    let answerVals = generateAnswers(currentAnswer);

    // Calculate container boundaries
    const containerWidth = answersContainer.clientWidth;
    const containerHeight = answersContainer.clientHeight;

    answerVals.forEach((val, i) => {
      const bubble = document.createElement('div');
      bubble.className = 'answerBubble';
      bubble.textContent = val;
      bubble.setAttribute('role', 'listitem');
      bubble.setAttribute('aria-label', `Answer option ${val}`);

      // Random start position inside container
      let posX = Math.random() * (containerWidth - 80);
      let posY = Math.random() * (containerHeight - 80);

      // Save float data
      floatPositions.push({ x: posX, y: posY });
      // Random float direction and speed for x and y, small values
      floatDirections.push({
        x: (Math.random() * 0.6 - 0.3),
        y: (Math.random() * 0.6 - 0.3)
      });

      bubble.style.left = posX + 'px';
      bubble.style.top = posY + 'px';

      answersContainer.appendChild(bubble);
      answers.push({ el: bubble, val });
    });

    shipPosIndex = 0;
    updateShipPosition();
  }

  // Animate floating stars inside container
  function animateStars() {
    const containerWidth = answersContainer.clientWidth;
    const containerHeight = answersContainer.clientHeight;

    answers.forEach((answer, i) => {
      let pos = floatPositions[i];
      let dir = floatDirections[i];

      // Update positions
      pos.x += dir.x;
      pos.y += dir.y;

      // Bounce off edges
      if(pos.x < 0 || pos.x > containerWidth - 80) dir.x = -dir.x;
      if(pos.y < 0 || pos.y > containerHeight - 80) dir.y = -dir.y;

      floatDirections[i] = dir;
      floatPositions[i] = pos;

      answer.el.style.left = pos.x + 'px';
      answer.el.style.top = pos.y + 'px';
    });
  }

  // Ship positioning: moves horizontally under answersContainer area
  // We'll move ship on a 5 position grid (matching answers)
  function updateShipPosition() {
    const containerWidth = answersContainer.clientWidth;
    const step = (containerWidth - 60) / (answers.length - 1);
    let x = step * shipPosIndex;

    ship.style.left = `${x + 10}px`; // small left margin
  }

  // Move ship left or right
  function moveShip(dir) {
    shipPosIndex += dir;
    if(shipPosIndex < 0) shipPosIndex = 0;
    if(shipPosIndex >= answers.length) shipPosIndex = answers.length - 1;
    updateShipPosition();
  }

  // Fire projectile (a star) from ship position moving upward to answer bubble
  function fireProjectile() {
    if(projectile) return; // only one at a time

    const projectileEl = document.createElement('div');
    projectileEl.className = 'projectile';
    projectileEl.setAttribute('aria-hidden', 'true');

    // Initial position: ship center top
    const shipRect = ship.getBoundingClientRect();
    const containerRect = answersContainer.getBoundingClientRect();

    const startX = shipRect.left + shipRect.width / 2 - containerRect.left - 20; // offset for projectile width/2
    const startY = answersContainer.clientHeight + 10;

    projectileEl.style.left = `${startX}px`;
    projectileEl.style.top = `${startY}px`;

    answersContainer.appendChild(projectileEl);
    projectile = { el: projectileEl, x: startX, y: startY };

    // Target answer position
    const targetBubble = answers[shipPosIndex].el;
    const targetRect = targetBubble.getBoundingClientRect();

    // Target center relative to container
    const targetX = targetRect.left + targetRect.width / 2 - containerRect.left - 20;
    const targetY = targetRect.top + targetRect.height / 2 - containerRect.top - 20;

    const dx = targetX - startX;
    const dy = targetY - startY;

    const distance = Math.sqrt(dx * dx + dy * dy);
    const speedPxPerFrame = projectileSpeedBase * speed; // speed scaled by slider

    let stepCount = distance / speedPxPerFrame;
    let stepX = dx / stepCount;
    let stepY = dy / stepCount;

    let step = 0;

    function animate() {
      if(!projectile) return;

      projectile.x += stepX;
      projectile.y += stepY;
      step++;

      projectile.el.style.left = projectile.x + 'px';
      projectile.el.style.top = projectile.y + 'px';

      // Collision detection (simple distance check)
      let distToTarget = Math.sqrt((projectile.x - targetX) ** 2 + (projectile.y - targetY) ** 2);
      if(distToTarget < 10 || step >= stepCount) {
        // Check answer correctness
        checkAnswer(answers[shipPosIndex].val);

        // Remove projectile
        projectile.el.remove();
        projectile = null;
        return;
      }
      requestAnimationFrame(animate);
    }

    requestAnimationFrame(animate);
  }

  // Check if the selected answer is correct
  function checkAnswer(val) {
    if(val === currentAnswer) {
      score += Math.floor(10 + speed * 2 + (60 - timeLeft) * 0.5);
      updateScore();
      updateAIMessage(true);
      setupAnswers();
    } else {
      wrongCount++;
      if(wrongCount >= 3) {
        updateAIMessage(false, true);
        wrongCount = 0;
      } else {
        updateAIMessage(false, false);
      }
    }
  }

  // AI Tutor motivational and hint messages
  function updateAIMessage(correct = true, frustrated = false) {
    let messages;
    if(frustrated) {
      messages = [
        "Oops! Don't worry, keep trying!",
        "Math stars can be tricky. Take your time!",
        "Let's slow down and try again!",
        "Remember: Practice makes perfect!"
      ];
    } else if(correct) {
      messages = tutorTips[currentMode] || ["You're doing awesome! Keep it up!"];
    } else {
      messages = [
        "Not quite, try aiming for the right star!",
        "Keep trying, you got this!",
        "The right star shines brighter!",
        "Almost there! You can do it!"
      ];
    }
    const msg = messages[Math.floor(Math.random() * messages.length)];
    aiMessage.textContent = msg;
  }

  // Main game loop for animations
  function gameLoop() {
    animateStars();
    requestAnimationFrame(gameLoop);
  }

  // Restart game
  function restartGame() {
    score = 0;
    timeLeft = 60;
    wrongCount = 0;
    updateScore();
    updateTimerDisplay();
    updateAIMessage(true);
    setupAnswers();
    startTimer();
  }

  // Handle mode change
  function changeMode(newMode) {
    currentMode = newMode;
    restartGame();
  }

  // Keyboard controls for accessibility
  function handleKeyDown(e) {
    if(e.repeat) return;
    switch(e.key) {
      case 'ArrowLeft':
        moveShip(-1);
        e.preventDefault();
        break;
      case 'ArrowRight':
        moveShip(1);
        e.preventDefault();
        break;
      case 'Enter':
      case ' ':
        fireProjectile();
        e.preventDefault();
        break;
    }
  }

  // Setup event listeners
  btnLeft.addEventListener('click', () => moveShip(-1));
  btnRight.addEventListener('click', () => moveShip(1));
  btnFire.addEventListener('click', fireProjectile);
  speedControl.addEventListener('input', (e) => {
    speed = Number(e.target.value);
  });
  modeRadios.forEach(radio => {
    radio.addEventListener('change', () => {
      if(radio.checked) changeMode(radio.value);
    });
  });
  window.addEventListener('keydown', handleKeyDown);

  // Initialize game
  setupAnswers();
  updateScore();
  startTimer();
  gameLoop();

  // Ask player if they want to restart on game over
  function gameOver() {
    alert(`Game Over! Your final score: ${score}`);
    if(confirm('Do you want to restart the game?')) {
      restartGame();
    } else {
      aiMessage.textContent = 'Thanks for playing! Refresh to play again.';
    }
  }
})();
</script>
</body>
</html>
