<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Math Invaders - Star Battle</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap');
  body {
    margin: 0;
    background: radial-gradient(circle at center, #000010, #000000);
    font-family: 'Orbitron', monospace;
    color: #0ff;
    overflow-x: hidden;
    user-select: none;
  }
  #game {
    position: relative;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
  }

  /* Question Billboard */
  #questionBillboard {
    display: flex;
    justify-content: center;
    align-items: center;
    background: #001122;
    border: 3px solid #0ff;
    border-radius: 20px;
    box-shadow: 0 0 25px #0ff;
    font-size: 2rem;
    font-weight: 700;
    padding: 15px 30px;
    width: 90%;
    max-width: 600px;
    margin: 15px auto 10px;
    text-align: center;
  }

  /* Ship */
  #ship {
    position: absolute;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 60px;
    filter: drop-shadow(0 0 8px #0ff);
    cursor: pointer;
  }
  /* Star shape for ship */
  #ship svg {
    fill: #0ff;
    stroke: #0cc;
    stroke-width: 2;
  }

  /* Projectile star */
  .projectile {
    position: absolute;
    width: 40px;
    height: 40px;
    pointer-events: none;
    filter: drop-shadow(0 0 6px #ff0);
    animation: glowStar 1s infinite alternate;
  }
  @keyframes glowStar {
    from { filter: drop-shadow(0 0 6px #ff0);}
    to { filter: drop-shadow(0 0 14px #ff0);}
  }

  /* Answers container flexbox */
  #answersContainer {
    display: flex;
    justify-content: space-evenly;
    align-items: center;
    position: absolute;
    top: 100px;
    width: 100%;
    max-width: 900px;
    left: 50%;
    transform: translateX(-50%);
    user-select: none;
  }

  /* Star bubble shape for answers */
  .answerBubble {
    position: relative;
    width: 90px;
    height: 90px;
    background: linear-gradient(45deg, #00ffff, #006666);
    clip-path: polygon(
      50% 0%, 61% 35%, 98% 35%, 68% 57%,
      79% 91%, 50% 70%, 21% 91%, 32% 57%,
      2% 35%, 39% 35%
    );
    box-shadow: 0 0 15px #0ff;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.8rem;
    font-weight: 700;
    color: #002222;
    cursor: pointer;
    transition: transform 0.2s ease;
    user-select: none;
  }
  .answerBubble:hover {
    transform: scale(1.2);
    box-shadow: 0 0 25px #0ff, 0 0 40px #0ff;
    color: #00ffff;
  }

  /* Controls container */
  #controls {
    position: absolute;
    bottom: 15px;
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 15px;
  }
  .btn {
    background: #001122;
    border: 2px solid #0ff;
    border-radius: 12px;
    color: #0ff;
    font-weight: 700;
    font-size: 24px;
    padding: 12px 24px;
    cursor: pointer;
    transition: background 0.3s, color 0.3s;
    user-select: none;
  }
  .btn:hover {
    background: #0ff;
    color: #001122;
  }

  /* Speed slider as star */
  #speedControl {
    position: absolute;
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
    width: 150px;
    -webkit-appearance: none;
    background: transparent;
  }
  #speedControl::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 40px;
    height: 40px;
    background: gold;
    clip-path: polygon(
      50% 0%, 61% 35%, 98% 35%, 68% 57%,
      79% 91%, 50% 70%, 21% 91%, 32% 57%,
      2% 35%, 39% 35%
    );
    cursor: pointer;
    box-shadow: 0 0 20px gold;
    transition: background 0.3s ease;
  }
  #speedControl::-webkit-slider-thumb:hover {
    background: #ffaa00;
  }
  #speedControl:focus {
    outline: none;
  }
  #speedControl::-moz-range-thumb {
    width: 40px;
    height: 40px;
    background: gold;
    clip-path: polygon(
      50% 0%, 61% 35%, 98% 35%, 68% 57%,
      79% 91%, 50% 70%, 21% 91%, 32% 57%,
      2% 35%, 39% 35%
    );
    cursor: pointer;
    box-shadow: 0 0 20px gold;
  }

  /* Responsive */
  @media (max-width: 600px) {
    #questionBillboard {
      font-size: 1.5rem;
      width: 95%;
      padding: 10px 15px;
    }
    .answerBubble {
      width: 70px;
      height: 70px;
      font-size: 1.3rem;
    }
    #speedControl {
      width: 120px;
    }
    .btn {
      font-size: 20px;
      padding: 10px 18px;
    }
  }
</style>
</head>
<body>

<div id="game">

  <div id="questionBillboard">Loading...</div>

  <div id="answersContainer"></div>

  <div id="ship" title="Your ship (tap buttons or arrow keys)">
    <!-- Simple star SVG ship -->
    <svg viewBox="0 0 64 64" width="60" height="60" aria-hidden="true">
      <polygon points="32,4 39,24 60,24 42,38 49,58 32,44 15,58 22,38 4,24 25,24" />
    </svg>
  </div>

  <input type="range" id="speedControl" min="1" max="5" value="3" title="Adjust speed" />

  <div id="controls">
    <button class="btn" id="btnLeft">‚¨ÖÔ∏è</button>
    <button class="btn" id="btnFire">üåü</button>
    <button class="btn" id="btnRight">‚û°Ô∏è</button>
  </div>

  <!-- Sounds -->
  <audio id="sndShoot" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
  <audio id="sndCorrect" src="https://actions.google.com/sounds/v1/cartoon/cartoon_cowbell.ogg"></audio>
  <audio id="sndWrong" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
  <audio id="bgMusic" src="https://actions.google.com/sounds/v1/ambiences/retro_game_start.ogg" loop></audio>

</div>

<script>
(() => {
  const game = document.getElementById('game');
  const questionBillboard = document.getElementById('questionBillboard');
  const answersContainer = document.getElementById('answersContainer');
  const ship = document.getElementById('ship');
  const btnLeft = document.getElementById('btnLeft');
  const btnRight = document.getElementById('btnRight');
  const btnFire = document.getElementById('btnFire');
  const speedControl = document.getElementById('speedControl');

  const sndShoot = document.getElementById('sndShoot');
  const sndCorrect = document.getElementById('sndCorrect');
  const sndWrong = document.getElementById('sndWrong');
  const bgMusic = document.getElementById('bgMusic');
  bgMusic.volume = 0.1;
  bgMusic.play();

  const modes = ['+', '-', '*', '/'];
  let modeIndex = 0;
  let score = 0;
  let speed = +speedControl.value;
  let shipX = window.innerWidth / 2 - 30; // ship width/2 offset
  let projectile = null;
  let projectileSpeed = 15;
  let currentAnswer = null;
  let answers = [];
  let question = '';
  let answerPositions = []; // track x positions of answer bubbles for collision

  ship.style.left = shipX + 'px';

  // Helper star SVG for projectile
  const starSVG = `<svg viewBox="0 0 64 64" width="40" height="40" aria-hidden="true" fill="gold" stroke="#ffaa00" stroke-width="2">
    <polygon points="32,4 39,24 60,24 42,38 49,58 32,44 15,58 22,38 4,24 25,24"/>
  </svg>`;

  function playSound(sound) {
    sound.currentTime = 0;
    sound.play();
  }

  function generateProblem() {
    let a = Math.floor(Math.random() * (10 + modeIndex * 10)) + 1;
    let b = Math.floor(Math.random() * (10 + modeIndex * 10)) + 1;
    let op = modes[modeIndex];

    if(op === '-' && b > a) [a,b] = [b,a];
    if(op === '/') {
      b = Math.floor(Math.random() * 9) + 1;
      a = b * (Math.floor(Math.random() * 7) + 1);
    }
    let answer = eval(`${a}${op}${b}`);
    if(!Number.isInteger(answer)) answer = answer.toFixed(2);
    return { text: `${a} ${op} ${b}`, answer };
  }

  function setupAnswers() {
    answersContainer.innerHTML = '';
    answers = [];

    // Create 5 answer bubbles including the correct answer
    let correctPos = Math.floor(Math.random() * 5);

    // generate wrong answers (close to correct)
    let wrongAnswers = new Set();
    while(wrongAnswers.size < 4) {
      let diff = (Math.random() < 0.5 ? -1 : 1) * (Math.floor(Math.random() * 5) + 1);
      let wrong = Number(currentAnswer) + diff;
      if(wrong !== currentAnswer && wrong > 0) wrongAnswers.add(wrong);
    }
    wrongAnswers = Array.from(wrongAnswers);

    for(let i = 0; i < 5; i++) {
      let val = (i === correctPos) ? currentAnswer : wrongAnswers.pop();
      let bubble = document.createElement('div');
      bubble.classList.add('answerBubble');
      bubble.textContent = val;
      answersContainer.appendChild(bubble);
      answers.push({el: bubble, val: val});
    }

    // Save answer bubble horizontal positions for collision detection
    // We'll set horizontal movement animation on them now:
    answerPositions = [];
    answers.forEach((a,i) => {
      // Set initial position
      a.el.style.position = 'relative';
      a.el.style.left = '0px';

      // Animate gentle side to side float
      let amplitude = 20 + Math.random()*15;
      let speedAnim = 2000 + Math.random()*2000;
      a.el.animate([
        { transform: `translateX(0px)` },
        { transform: `translateX(${amplitude}px)` },
        { transform: `translateX(0px)` },
        { transform: `translateX(${-amplitude}px)` },
        { transform: `translateX(0px)` }
      ], {
        duration: speedAnim,
        iterations: Infinity
      });
    });
  }

  function generateCurrentQuestion() {
    let prob = generateProblem();
    question = prob.text;
    currentAnswer = prob.answer;
    questionBillboard.textContent = `Solve: ${question}`;
  }

  // Move ship left or right
  function moveShip(dir) {
    shipX += dir * 30;
    shipX = Math.max(0, Math.min(window.innerWidth - ship.offsetWidth, shipX));
    ship.style.left = shipX + 'px';
  }

  // Fire projectile (giant star)
  function fireProjectile() {
    if(projectile) return;
    projectile = document.createElement('div');
    projectile.classList.add('projectile');
    projectile.style.left = (shipX + ship.offsetWidth / 2 - 20) + 'px';
    projectile.style.top = (window.innerHeight - 80) + 'px';
    projectile.innerHTML = starSVG;
    game.appendChild(projectile);
    playSound(sndShoot);
  }

  // Update projectile position and check collision with answers
  function updateProjectile() {
    if(!projectile) return;
    let top = parseFloat(projectile.style.top);
    top -= projectileSpeed + (speed - 1) * 2; // scale speed with slider
    projectile.style.top = top + 'px';

    if(top < 0) {
      projectile.remove();
      projectile = null;
      return;
    }

    // Collision check: projectile's horizontal center with each bubble bounding box
    let projX = parseFloat(projectile.style.left) + 20;
    let projY = top + 20;

    for(let i=0; i < answers.length; i++) {
      const bubble = answers[i];
      const rect = bubble.el.getBoundingClientRect();

      if(projX > rect.left && projX < rect.right && projY > rect.top && projY < rect.bottom) {
        // Hit answer bubble
        if(bubble.val == currentAnswer) {
          // Correct hit!
          playSound(sndCorrect);
          score++;
          questionBillboard.textContent = `Correct! Score: ${score}`;
          projectile.remove();
          projectile = null;
          nextRound();
          return;
        } else {
          playSound(sndWrong);
          questionBillboard.textContent = `Wrong! Try again.`;
          projectile.remove();
          projectile = null;
          return;
        }
      }
    }
  }

  // Start next round: change difficulty and question
  function nextRound() {
    // Every 5 points increase difficulty by cycling mode and speeding up
    if(score % 5 === 0) {
      modeIndex = (modeIndex + 1) % modes.length;
      questionBillboard.textContent += ` Mode: ${modes[modeIndex]}`;
      speedControl.value = Math.min(5, +speedControl.value + 1);
      speed = +speedControl.value;
    }
    generateCurrentQuestion();
    setupAnswers();
  }

  // Controls events
  btnLeft.onclick = () => moveShip(-1);
  btnRight.onclick = () => moveShip(1);
  btnFire.onclick = () => fireProjectile();
  speedControl.oninput = (e) => {
    speed = +e.target.value;
  };

  // Keyboard support
  window.addEventListener('keydown', e => {
    if(e.key === 'ArrowLeft') moveShip(-1);
    if(e.key === 'ArrowRight') moveShip(1);
    if(e.key === ' ' || e.key === 'ArrowUp') fireProjectile();
  });

  // Game loop
  function gameLoop() {
    updateProjectile();
    requestAnimationFrame(gameLoop);
  }

  // Initialize
  generateCurrentQuestion();
  setupAnswers();
  gameLoop();

  // Optional: Restart prompt on game over (wrong answer more than 3 times)
  let wrongCount = 0;
  function handleWrong() {
    wrongCount++;
    if(wrongCount >= 3) {
      if(confirm(`Too many wrong answers! Restart game?`)) {
        location.reload();
      } else {
        wrongCount = 0;
      }
    }
  }
  // Modify updateProjectile to call handleWrong on wrong hit:
  const originalUpdateProjectile = updateProjectile;
  updateProjectile = () => {
    if(!projectile) return;
    let top = parseFloat(projectile.style.top);
    top -= projectileSpeed + (speed - 1) * 2; 
    projectile.style.top = top + 'px';

    if(top < 0) {
      projectile.remove();
      projectile = null;
      return;
    }

    let projX = parseFloat(projectile.style.left) + 20;
    let projY = top + 20;

    for(let i=0; i < answers.length; i++) {
      const bubble = answers[i];
      const rect = bubble.el.getBoundingClientRect();

      if(projX > rect.left && projX < rect.right && projY > rect.top && projY < rect.bottom) {
        if(bubble.val == currentAnswer) {
          playSound(sndCorrect);
          score++;
          questionBillboard.textContent = `Correct! Score: ${score}`;
          projectile.remove();
          projectile = null;
          wrongCount = 0;
          nextRound();
          return;
        } else {
          playSound(sndWrong);
          questionBillboard.textContent = `Wrong! Try again.`;
          projectile.remove();
          projectile = null;
          handleWrong();
          return;
        }
      }
    }
  };

})();
</script>

</body>
</html>
