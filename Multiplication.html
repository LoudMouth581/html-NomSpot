<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Multiplication Mastery Quest</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Baloo+2&display=swap');
    body {
      font-family: 'Baloo 2', cursive, sans-serif;
      background: linear-gradient(135deg, #f06292, #ec407a);
      color: #fff;
      margin: 0; padding: 0;
      display: flex; flex-direction: column;
      align-items: center;
      min-height: 100vh;
      user-select: none;
    }
    header {
      padding: 20px;
      text-align: center;
      background: #ad1457;
      width: 100%;
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    }
    header h1 {
      margin: 0;
      font-weight: 700;
      font-size: 2rem;
      text-shadow: 0 0 8px #f48fb1;
    }
    #mascot {
      margin: 10px 0 20px;
      font-size: 1.4rem;
      background: rgba(255 255 255 / 0.1);
      padding: 12px 18px;
      border-radius: 16px;
      width: 90%;
      max-width: 480px;
      box-shadow: 0 0 12px #f48fb1;
      min-height: 50px;
      transition: background 0.3s ease;
      user-select: none;
    }
    main {
      flex: 1;
      width: 90%;
      max-width: 480px;
      background: #ce93d8;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #question {
      font-size: 2.5rem;
      margin-bottom: 20px;
      font-weight: 700;
      letter-spacing: 2px;
      user-select: text;
    }
    #answers {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
      width: 100%;
    }
    button.answer-btn {
      background: #ba68c8;
      border: none;
      border-radius: 12px;
      padding: 15px 25px;
      font-size: 1.2rem;
      font-weight: 600;
      color: white;
      cursor: pointer;
      box-shadow: 0 0 10px #ce93d8;
      transition: background 0.3s ease, transform 0.15s ease;
      user-select: none;
      flex: 1 1 40%;
      max-width: 160px;
      min-width: 140px;
    }
    button.answer-btn:hover {
      background: #d1c4e9;
      color: #4a148c;
      transform: scale(1.1);
    }
    button.answer-btn:active {
      transform: scale(0.95);
    }
    #scoreboard {
      width: 100%;
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      font-weight: 600;
      font-size: 1.2rem;
      user-select: none;
    }
    #timerBar {
      width: 100%;
      height: 12px;
      background: #9c27b0;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
      box-shadow: inset 0 0 5px #6a1b9a;
    }
    #timerFill {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #f48fb1, #c2185b);
      transition: width 0.1s linear;
    }
    #message {
      font-size: 1.4rem;
      height: 28px;
      margin-bottom: 15px;
      text-align: center;
      min-height: 40px;
      user-select: none;
    }
    #confetti-container {
      pointer-events: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      overflow: visible;
      z-index: 9999;
      display: none;
    }
    .confetti-piece {
      position: absolute;
      width: 8px; height: 8px;
      background-color: #fce4ec;
      opacity: 0.9;
      animation-name: confetti-fall;
      animation-timing-function: ease-out;
      animation-iteration-count: 1;
      border-radius: 3px;
    }
    @keyframes confetti-fall {
      0% {
        opacity: 1;
        transform: translateY(0) rotate(0deg);
      }
      100% {
        opacity: 0;
        transform: translateY(100vh) rotate(360deg);
      }
    }
    footer {
      margin: 10px 0 20px;
      font-size: 0.9rem;
      color: #eee;
      user-select: none;
    }
  </style>
</head>
<body>

<header>
  <h1>Multiplication Mastery Quest</h1>
</header>

<div id="mascot" aria-live="polite" role="region">Hey there! Ready to become a multiplication champ?</div>

<main>
  <div id="scoreboard">
    <div>Score: <span id="score">0</span></div>
    <div>Strikes: <span id="strikes">0</span>/3</div>
  </div>
  <div id="timerBar" aria-label="Timer progress bar">
    <div id="timerFill"></div>
  </div>
  <div id="question" aria-live="assertive" aria-atomic="true"></div>
  <div id="answers" role="list"></div>
  <div id="message" aria-live="polite" aria-atomic="true"></div>
</main>

<div id="confetti-container" aria-hidden="true"></div>

<footer>
  &copy; 2025 Multiplication Mastery Quest — Practice makes perfect!
</footer>

<script>
(() => {
  const mascotEl = document.getElementById('mascot');
  const questionEl = document.getElementById('question');
  const answersEl = document.getElementById('answers');
  const scoreEl = document.getElementById('score');
  const strikesEl = document.getElementById('strikes');
  const messageEl = document.getElementById('message');
  const timerFillEl = document.getElementById('timerFill');
  const confettiContainer = document.getElementById('confetti-container');

  // Sounds
  const correctSound = new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg');
  const wrongSound = new Audio('https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg');

  let score = 0;
  let strikes = 0;
  let streak = 0;
  let timeLeft = 15; // seconds per question
  let timerInterval;
  let currentAnswer = null;
  let canAnswer = true;

  // Load saved progress
  function loadProgress() {
    const data = localStorage.getItem('multiplicationMasteryQuest');
    if (data) {
      const parsed = JSON.parse(data);
      score = parsed.score || 0;
      strikes = parsed.strikes || 0;
      streak = parsed.streak || 0;
      updateScoreboard();
    }
  }

  // Save progress to localStorage
  function saveProgress() {
    localStorage.setItem('multiplicationMasteryQuest', JSON.stringify({
      score, strikes, streak
    }));
  }

  function speak(text) {
    if (!('speechSynthesis' in window)) return;
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'en-US';
    window.speechSynthesis.cancel(); // stop previous speech
    window.speechSynthesis.speak(utter);
  }

  function randomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function generateQuestion() {
    // Increase difficulty as score grows
    const maxNum = Math.min(5 + Math.floor(score / 10) * 3, 15);
    let a = randomInt(1, maxNum);
    let b = randomInt(1, maxNum);

    currentAnswer = a * b;
    questionEl.textContent = `What is ${a} × ${b}?`;

    speak(`What is ${a} times ${b}?`);

    generateAnswers(currentAnswer);
    resetTimer();
    canAnswer = true;
    messageEl.textContent = "";
    mascotEl.textContent = pickMascotMessage();
  }

  function generateAnswers(correct) {
    answersEl.innerHTML = "";
    const answersSet = new Set();
    answersSet.add(correct);

    while (answersSet.size < 5) {
      let fakeAnswer = correct + randomInt(-10, 10);
      if (fakeAnswer < 0) fakeAnswer = 0;
      answersSet.add(fakeAnswer);
    }

    const answersArr = Array.from(answersSet);
    // Shuffle answers
    for (let i = answersArr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [answersArr[i], answersArr[j]] = [answersArr[j], answersArr[i]];
    }

    answersArr.forEach(ans => {
      const btn = document.createElement('button');
      btn.className = 'answer-btn';
      btn.textContent = ans;
      btn.setAttribute('role', 'listitem');
      btn.onclick = () => {
        if (!canAnswer) return;
        canAnswer = false;
        checkAnswer(ans);
      };
      answersEl.appendChild(btn);
    });
  }

  function checkAnswer(answer) {
    if (answer === currentAnswer) {
      handleCorrect();
    } else {
      handleWrong();
    }
  }

  function handleCorrect() {
    score += 10;
    streak++;
    strikes = 0;
    updateScoreboard();
    messageEl.textContent = "✅ Correct! Well done!";
    mascotEl.textContent = randomPositiveMascotMessage();
    playSound(correctSound);

    if (streak > 0 && streak % 3 === 0) {
      messageEl.textContent += " 🎯 Quick fire bonus round!";
      mascotEl.textContent = "Speed it up!";
      timeLeft = 8;
    }

    showConfetti();
    saveProgress();

    setTimeout(generateQuestion, 1500);
  }

  function handleWrong() {
    strikes++;
    streak = 0;
    updateScoreboard();
    messageEl.textContent = `❌ Wrong! Strike ${strikes} of 3.`;
    mascotEl.textContent = randomEncourageMascotMessage();
    playSound(wrongSound);

    if (strikes >= 3) {
      messageEl.textContent = "⚠️ 3 Strikes! Level reset.";
      mascotEl.textContent = "Keep trying!";
      score = 0;
      strikes = 0;
      streak = 0;
      updateScoreboard();
      saveProgress();
      setTimeout(generateQuestion, 2000);
    } else {
      setTimeout(generateQuestion, 1500);
    }
  }

  function updateScoreboard() {
    scoreEl.textContent = score;
    strikesEl.textContent = strikes;
  }

  // Timer logic
  function resetTimer() {
    clearInterval(timerInterval);
    timeLeft = streak > 0 && streak % 3 === 0 ? 8 : 15;
    timerFillEl.style.width = "100%";

    timerInterval = setInterval(() => {
      timeLeft -= 0.1;
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        canAnswer = false;
        messageEl.textContent = "⏰ Time's up!";
        mascotEl.textContent = "Try to be quicker!";
        strikes++;
        streak = 0;
        updateScoreboard();
        saveProgress();
        if (strikes >= 3) {
          messageEl.textContent = "⚠️ 3 Strikes! Level reset.";
          mascotEl.textContent = "You can do it!";
          score = 0;
          strikes = 0;
          updateScoreboard();
          setTimeout(generateQuestion, 2000);
        } else {
          setTimeout(generateQuestion, 1500);
        }
        return;
      }
      timerFillEl.style.width = (timeLeft / (streak > 0 && streak % 3 === 0 ? 8 : 15)) * 100 + '%';
    }, 100);
  }

  function playSound(sound) {
    sound.currentTime = 0;
    sound.play().catch(() => {});
  }

  // Confetti animation (CSS only)
  function showConfetti() {
    confettiContainer.style.display = 'block';
    for(let i = 0; i < 30; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti-piece';
      confetti.style.backgroundColor = `hsl(${Math.random()*360}, 70%, 80%)`;
      confetti.style.left = Math.random() * 100 + 'vw';
      confetti.style.animationDuration = 2 + Math.random()*1.5 + 's';
      confetti.style.animationDelay = Math.random()*1 + 's';
      confetti.style.width = confetti.style.height = 5 + Math.random()*5 + 'px';
      confettiContainer.appendChild(confetti);

      confetti.addEventListener('animationend', () => {
        confetti.remove();
      });
    }
    setTimeout(() => {
      confettiContainer.style.display = 'none';
    }, 3000);
  }

  // Mascot messages
  const positiveMessages = [
    "You're crushing it!",
    "Math wizard in the making!",
    "Keep up the great work!",
    "Fantastic answer!",
    "You're unstoppable!"
  ];
  const encourageMessages = [
    "Don't give up!",
    "Try again, you got this!",
    "Almost there!",
    "Keep pushing!",
    "Mistakes help us learn!"
  ];
  const defaultMessages = [
    "Ready for your next challenge?",
    "Multiply those numbers!",
    "I believe in you!",
    "Let's conquer multiplication!",
    "Keep your focus!"
  ];

  function randomPositiveMascotMessage() {
    return positiveMessages[Math.floor(Math.random()*positiveMessages.length)];
  }
  function randomEncourageMascotMessage() {
    return encourageMessages[Math.floor(Math.random()*encourageMessages.length)];
  }
  function pickMascotMessage() {
    if (strikes > 0) {
      return randomEncourageMascotMessage();
    }
    if (streak > 0) {
      return randomPositiveMascotMessage();
    }
    return defaultMessages[Math.floor(Math.random()*defaultMessages.length)];
  }

  // Initialize game
  loadProgress();
  generateQuestion();

  // Accessibility: Announce question with TTS on load
  window.addEventListener('load', () => {
    speak(questionEl.textContent);
  });

  // Stop speech on page unload
  window.addEventListener('beforeunload', () => {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
    }
  });
})();
</script>

</body>
</html>
