<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Algebra Ace - Speed & Accuracy Trainer</title>
<style>
  body {
    margin:0; padding:0;
    background: linear-gradient(135deg, #1c1c3c, #2a2a5c);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #eef9ff;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    user-select: none;
  }
  header {
    padding: 1rem 0;
    font-size: 2rem;
    font-weight: 700;
    text-align: center;
    color: #a0d8f7;
    text-shadow: 0 0 10px #8bc4f9;
  }
  #game-container {
    background: #222244;
    border-radius: 15px;
    padding: 20px 30px;
    width: 90vw;
    max-width: 480px;
    box-shadow: 0 0 25px #8bc4f9aa;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  #mascot {
    width: 120px;
    height: 120px;
    margin-bottom: 10px;
    background: url('https://i.imgur.com/xdP2yfi.png') no-repeat center/contain;
    filter: drop-shadow(0 0 6px #8bc4f9);
  }
  #mascot-message {
    background: #1a1a3acc;
    padding: 8px 15px;
    border-radius: 12px;
    min-height: 40px;
    font-weight: 600;
    margin-bottom: 20px;
    text-align: center;
  }
  #question {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 15px;
    color: #8bc4f9;
    text-align: center;
  }
  #answers {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
  }
  .answer-btn {
    background: #2a2a5c;
    border-radius: 12px;
    padding: 15px 25px;
    font-size: 1.4rem;
    font-weight: 700;
    color: #eef9ff;
    box-shadow: 0 0 10px #8bc4f9bb;
    cursor: pointer;
    user-select: none;
    transition: transform 0.15s ease, background-color 0.3s ease;
    min-width: 80px;
    text-align: center;
  }
  .answer-btn:hover {
    background-color: #8bc4f9;
    color: #222244;
    transform: scale(1.1);
  }
  #scoreboard {
    width: 100%;
    display: flex;
    justify-content: space-between;
    color: #8bc4f9;
    font-weight: 700;
    font-size: 1.2rem;
    margin-bottom: 15px;
  }
  #progress-bar {
    width: 100%;
    background: #2a2a5c;
    border-radius: 15px;
    overflow: hidden;
    height: 18px;
    margin-bottom: 20px;
    box-shadow: inset 0 0 8px #8bc4f9aa;
  }
  #progress-fill {
    height: 100%;
    background: #8bc4f9;
    width: 0%;
    transition: width 0.3s ease;
  }
  #message {
    font-weight: 700;
    height: 24px;
    margin-bottom: 15px;
    min-height: 24px;
    text-align: center;
  }
  #powerups {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 10px;
  }
  .powerup-btn {
    background: #2a2a5c;
    border-radius: 12px;
    padding: 10px 18px;
    font-weight: 700;
    color: #eef9ff;
    cursor: pointer;
    box-shadow: 0 0 10px #8bc4f9bb;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  .powerup-btn:disabled {
    opacity: 0.4;
    cursor: default;
  }
  .powerup-btn:hover:not(:disabled) {
    background-color: #8bc4f9;
    color: #222244;
  }
  #level-display {
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 15px;
    text-align: center;
    color: #8bc4f9;
  }
  #unlockables {
    width: 100%;
    background: #222244;
    border-radius: 15px;
    padding: 10px;
    box-shadow: inset 0 0 15px #8bc4f9aa;
    color: #8bc4f9cc;
    font-weight: 600;
    font-size: 1rem;
    max-height: 120px;
    overflow-y: auto;
  }
  .confetti-piece {
    position: fixed;
    width: 10px; height: 10px;
    background-color: #8bc4f9;
    opacity: 0.9;
    pointer-events: none;
    animation: confetti-fall 1.2s ease forwards;
    border-radius: 2px;
  }
  @keyframes confetti-fall {
    0% {transform: translateY(0) rotate(0deg);}
    100% {transform: translateY(100vh) rotate(360deg); opacity: 0;}
  }
  @media (max-width: 480px) {
    #game-container {
      width: 95vw;
      padding: 15px 20px;
    }
    #mascot {
      width: 90px;
      height: 90px;
    }
    .answer-btn {
      min-width: 70px;
      font-size: 1.2rem;
      padding: 12px 18px;
    }
  }
</style>
</head>
<body>
<header>Algebra Ace</header>

<div id="game-container" role="main" aria-live="polite">
  <div id="mascot" aria-label="Mascot"></div>
  <div id="mascot-message" aria-live="polite">Let's solve some equations!</div>

  <div id="scoreboard">
    <div>Score: <span id="score">0</span></div>
    <div>Level: <span id="level">1</span></div>
    <div>Strikes: <span id="strikes">0</span>/3</div>
  </div>

  <div id="progress-bar" aria-label="Progress bar">
    <div id="progress-fill"></div>
  </div>

  <div id="question" aria-label="Algebra question" role="heading" aria-level="2">Loading question...</div>

  <div id="answers" role="list" aria-label="Answer choices"></div>

  <div id="message" aria-live="assertive"></div>

  <div id="powerups" aria-label="Power-ups">
    <button id="doublePointsBtn" class="powerup-btn" aria-pressed="false" title="Double your points on the next correct answer!">Double Points</button>
    <button id="skipBtn" class="powerup-btn" aria-pressed="false" title="Skip a question without penalty!">Skip Question</button>
  </div>

  <div id="unlockables" aria-live="polite" aria-label="Unlockable titles and badges">
    <strong>Unlockables:</strong>
    <ul id="unlockList"></ul>
  </div>
</div>

<script>
(() => {
  const scoreEl = document.getElementById('score');
  const levelEl = document.getElementById('level');
  const strikesEl = document.getElementById('strikes');
  const questionEl = document.getElementById('question');
  const answersEl = document.getElementById('answers');
  const messageEl = document.getElementById('message');
  const progressFill = document.getElementById('progress-fill');
  const mascotMessage = document.getElementById('mascot-message');
  const unlockList = document.getElementById('unlockList');

  const doublePointsBtn = document.getElementById('doublePointsBtn');
  const skipBtn = document.getElementById('skipBtn');

  // Audio setup
  const correctSound = new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg');
  const wrongSound = new Audio('https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg');
  const levelUpSound = new Audio('https://actions.google.com/sounds/v1/cartoon/slide_whistle_to_drum_hit.ogg');

  // Text to Speech
  function speak(text) {
    if ('speechSynthesis' in window) {
      const utterance = new SpeechSynthesisUtterance(text);
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utterance);
    }
  }

  // Game state
  let score = 0;
  let level = 1;
  let strikes = 0;
  let streak = 0;
  let progress = 0;
  let doublePointsActive = false;
  let skipAvailable = 1;

  // Unlockables
  const unlockables = [
    { title: "Equation Explorer", threshold: 50, unlocked: false },
    { title: "Variable Virtuoso", threshold: 120, unlocked: false },
    { title: "Algebra Ace", threshold: 250, unlocked: false },
    { title: "X Solver Supreme", threshold: 400, unlocked: false }
  ];

  // Mascot phrases
  const mascotsPhrases = {
    start: ["Let's solve some equations!", "Sharpen your algebra skills!", "Ready to find the value of x?"],
    correct: ["Great job!", "You got it!", "Correct! Keep going!"],
    wrong: ["Oops! Try again.", "Not quite, you got this!", "Keep trying!"],
    levelUp: ["Level up! Algebra mastery awaits!", "You‚Äôre getting better!", "Keep it up!"]
  };

  // Utility
  function randomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function shuffleArray(arr) {
    for(let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  // Save/load progress with localStorage
  function saveProgress() {
    const data = { score, level, strikes, streak, progress, doublePointsActive, skipAvailable, unlockables };
    localStorage.setItem('algebraAceProgress', JSON.stringify(data));
  }

  function loadProgress() {
    const data = localStorage.getItem('algebraAceProgress');
    if (data) {
      const d = JSON.parse(data);
      score = d.score ?? 0;
      level = d.level ?? 1;
      strikes = d.strikes ?? 0;
      streak = d.streak ?? 0;
      progress = d.progress ?? 0;
      doublePointsActive = d.doublePointsActive ?? false;
      skipAvailable = d.skipAvailable ?? 1;
      // Restore unlocks safely
      unlockables.forEach(u => {
        const unlocked = d.unlockables?.find(x => x.title === u.title);
        u.unlocked = unlocked ? unlocked.unlocked : false;
      });
    }
  }

  // Update UI scoreboard and progress bar
  function updateScoreboard() {
    scoreEl.textContent = score;
    levelEl.textContent = level;
    strikesEl.textContent = strikes;
    progressFill.style.width = `${progress}%`;
    doublePointsBtn.disabled = doublePointsActive;
    skipBtn.textContent = `Skip Question (${skipAvailable})`;
    skipBtn.disabled = skipAvailable <= 0;
  }

  // Update unlockables list
  function updateUnlockablesUI() {
    unlockList.innerHTML = '';
    unlockables.forEach(u => {
      const li = document.createElement('li');
      li.textContent = `${u.unlocked ? 'üèÖ' : 'üîí'} ${u.title}`;
      unlockList.appendChild(li);
    });
  }

  // Generate an algebra linear equation question
  // Format: a*x + b = c  (solve for x)
  // x can be integer or decimal (up to 1 decimal place)
  function generateQuestion() {
    messageEl.textContent = '';
    answersEl.innerHTML = '';

    const maxNum = 10 + (level - 1) * 5;

    // a != 0
    let a = randomInt(1, Math.min(maxNum, 15));
    let x; // solution x
    let b = randomInt(-maxNum, maxNum);
    // Pick solution x as integer or decimal with 0.5 steps
    if (Math.random() < 0.7) {
      x = randomInt(1, maxNum);
    } else {
      x = Math.round((Math.random() * maxNum) * 2) / 2;
    }

    // Calculate c
    let c = Math.round((a * x + b) * 10) / 10;

    // Format equation nicely
    function formatTerm(coef, variable=true) {
      if (coef === 0) return '';
      let sign = coef > 0 ? '+' : '-';
      let absCoef = Math.abs(coef);
      if (variable) {
        if (absCoef === 1) return ` ${sign} x`;
        return ` ${sign} ${absCoef}x`;
      } else {
        return ` ${sign} ${absCoef}`;
      }
    }

    // Equation string
    let equation = '';

    // Handle sign of a*x, no plus for first positive term
    if (a === 1) equation += 'x';
    else if (a === -1) equation += '-x';
    else equation += a + 'x';

    // Append b term (can be positive or negative)
    if (b !== 0) {
      equation += b > 0 ? ` + ${b}` : ` - ${Math.abs(b)}`;
    }

    equation += ` = ${c}`;

    // Question text with simple wording
    questionEl.textContent = `Solve for x: ${equation}`;

    speak(`Solve for x: ${equation}`);

    // Generate answer choices
    let choices = new Set();
    choices.add(x);

    // Generate 3 wrong answers
    while (choices.size < 4) {
      let wrong;
      // Generate near misses
      if (Math.random() < 0.6) {
        wrong = Math.round((x + randomInt(-3,3) + (Math.random() < 0.5 ? 0.5 : 0)) * 10) / 10;
      } else {
        wrong = Math.round((randomInt(1, maxNum) + (Math.random() < 0.5 ? 0.5 : 0)) * 10) / 10;
      }
      if (wrong !== x && wrong >= -maxNum && wrong <= maxNum) {
        choices.add(wrong);
      }
    }

    let choicesArr = Array.from(choices);
    shuffleArray(choicesArr);

    choicesArr.forEach(choice => {
      const btn = document.createElement('button');
      btn.className = 'answer-btn';
      btn.textContent = choice % 1 === 0 ? choice : choice.toFixed(1);
      btn.setAttribute('role', 'listitem');
      btn.addEventListener('click', () => handleAnswer(choice, x));
      answersEl.appendChild(btn);
    });

    startTimer();
  }

  // Timer & scoring bonus for speed
  let questionStartTime = 0;
  let timerId;
  const TIME_LIMIT_MS = 15000;

  function startTimer() {
    clearTimeout(timerId);
    questionStartTime = Date.now();
    timerId = setTimeout(() => {
      messageEl.textContent = "Time's up! Strike added.";
      playSound(wrongSound);
      strikes++;
      streak = 0;
      updateScoreboard();
      checkReset();
      setTimeout(generateQuestion, 1500);
    }, TIME_LIMIT_MS);
  }

  function stopTimer() {
    clearTimeout(timerId);
  }

  // Handle answer click
  function handleAnswer(selected, correct) {
    stopTimer();
    if (Math.abs(selected - correct) < 0.01) {
      playCorrect();
    } else {
      playWrong();
    }
  }

  // Play sounds helper
  function playSound(audio) {
    audio.currentTime = 0;
    audio.play().catch(() => {});
  }

  // Confetti animation (CSS only)
  function showConfetti() {
    for (let i=0; i<30; i++) {
      const confetti = document.createElement('div');
      confetti.classList.add('confetti-piece');
      confetti.style.left = Math.random() * window.innerWidth + 'px';
      confetti.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 70%)`;
      confetti.style.animationDuration = 0.8 + Math.random() * 0.7 + 's';
      confetti.style.width = confetti.style.height = (5 + Math.random()*7) + 'px';
      confetti.style.top = '-10px';
      document.body.appendChild(confetti);
      setTimeout(() => confetti.remove(), 1500);
    }
  }

  // Mascot speaks random phrase from category
  function mascotSpeakRandom(category) {
    const arr = mascotsPhrases[category];
    if (!arr) return;
    const phrase = arr[Math.floor(Math.random()*arr.length)];
    mascotMessage.textContent = phrase;
    speak(phrase);
  }

  // Power-ups
  doublePointsBtn.addEventListener('click', () => {
    if (!doublePointsActive) {
      doublePointsActive = true;
      doublePointsBtn.disabled = true;
      doublePointsBtn.setAttribute('aria-pressed', 'true');
      mascotMessage.textContent = "Double points ready for next correct answer!";
    }
  });

  skipBtn.addEventListener('click', () => {
    if (skipAvailable > 0) {
      skipAvailable--;
      updateScoreboard();
      mascotMessage.textContent = "Question skipped! No penalty.";
      setTimeout(generateQuestion, 500);
    }
  });

  // Correct answer handler
  function playCorrect() {
    playSound(correctSound);

    let timeTaken = (Date.now() - questionStartTime) / 1000; // seconds
    let basePoints = 10;
    // Speed bonus for answering < 5s
    let speedBonus = timeTaken < 5 ? Math.round((5 - timeTaken) * 4) : 0;
    let points = basePoints + speedBonus;

    if (doublePointsActive) {
      points *= 2;
      doublePointsActive = false;
      doublePointsBtn.disabled = false;
      doublePointsBtn.setAttribute('aria-pressed', 'false');
      mascotMessage.textContent = "Double points used!";
    } else {
      mascotSpeakRandom('correct');
    }

    score += points;
    streak++;
    strikes = 0;
    progress = Math.min(100, progress + 20);

    updateScoreboard();
    messageEl.textContent = `Correct! +${points} points (+${speedBonus} speed bonus)`;

    // Check unlockables
    unlockables.forEach(u => {
      if (!u.unlocked && score >= u.threshold) {
        u.unlocked = true;
        mascotMessage.textContent = `Unlocked: ${u.title}! üéâ`;
        playSound(levelUpSound);
        showConfetti();
      }
    });
    updateUnlockablesUI();

    // Level up every 100 points
    if (score >= level * 100) {
      level++;
      progress = 0;
      mascotSpeakRandom('levelUp');
      playSound(levelUpSound);
      showConfetti();
      messageEl.textContent = `Level up! Welcome to level ${level}!`;
    }

    updateScoreboard();

    // Quick fire round every 3 correct
    if (streak % 3 === 0) {
      mascotMessage.textContent = "Quick fire round! Answer fast!";
      startTimer(); // reset timer for quick round
    }

    saveProgress();

    setTimeout(generateQuestion, 1500);
  }

  // Wrong answer handler
  function playWrong() {
    playSound(wrongSound);
    mascotSpeakRandom('wrong');
    strikes++;
    streak = 0;
    progress = Math.max(0, progress - 10);
    updateScoreboard();
    messageEl.textContent = `Wrong! Strike ${strikes}/3`;

    if (strikes >= 3) {
      mascotMessage.textContent = "3 strikes! Level reset.";
      score = Math.max(0, score - 50);
      level = Math.max(1, level - 1);
      strikes = 0;
      streak = 0;
      progress = 0;
      playSound(levelUpSound);
      showConfetti();
      messageEl.textContent = "Level reset! Try again.";
      updateScoreboard();
    }

    saveProgress();

    setTimeout(generateQuestion, 1500);
  }

  function checkReset() {
    if (strikes >= 3) {
      score = Math.max(0, score - 50);
      level = Math.max(1, level - 1);
      strikes = 0;
      streak = 0;
      progress = 0;
      playSound(levelUpSound);
      showConfetti();
      mascotMessage.textContent = "Level reset! Try again.";
      updateScoreboard();
    }
  }

  // Initialize
  function init() {
    loadProgress();
    updateScoreboard();
    updateUnlockablesUI();
    mascotSpeakRandom('start');
    generateQuestion();
  }

  init();
})();
</script>
</body>
</html>
