<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Geometry Tutor</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      background: white;
      color: #2E7D32;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    h1 {
      color: #1B5E20;
      margin-bottom: 5px;
    }
    #mascot {
      font-size: 3rem;
      margin: 10px;
    }
    #mascot-message {
      background: #F0F4C3;
      border: 2px solid #81C784;
      padding: 10px 15px;
      border-radius: 12px;
      min-height: 50px;
      text-align: center;
      margin-bottom: 20px;
      font-weight: bold;
      user-select: none;
    }
    #question-box {
      background: #ffffff;
      border: 3px solid #66BB6A;
      border-radius: 12px;
      padding: 20px;
      font-size: 1.4em;
      margin-bottom: 20px;
      max-width: 700px;
      text-align: center;
      user-select: none;
    }
    .diagram {
      margin: 15px 0;
      width: 240px;
      height: 240px;
      border: 2px solid #66BB6A;
      border-radius: 12px;
      position: relative;
      user-select: none;
    }
    svg {
      width: 100%;
      height: 100%;
      display: block;
      border-radius: 12px;
    }
    text {
      font-family: 'Comic Sans MS', cursive, sans-serif;
      font-weight: bold;
      font-size: 14px;
      pointer-events: none;
      user-select: none;
    }
    .label-length { fill: #e91e63; }
    .label-width { fill: #ff9800; }
    .label-radius { fill: #2196f3; }
    .label-height { fill: #8bc34a; }
    .label-angle { fill: #673ab7; font-size: 16px; }
    .answers {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      max-width: 700px;
      margin-bottom: 10px;
    }
    .answer {
      background: #A5D6A7;
      border: 2px solid #66BB6A;
      border-radius: 10px;
      padding: 12px 20px;
      cursor: pointer;
      transition: transform 0.2s, background-color 0.3s;
      font-weight: bold;
      min-width: 100px;
      text-align: center;
      user-select: none;
    }
    .answer:hover {
      background-color: #81C784;
      transform: scale(1.05);
    }
    .answer.correct {
      background-color: #C5E1A5;
      border-color: #558B2F;
    }
    .answer.wrong {
      background-color: #FFCDD2;
      border-color: #E53935;
    }
    #feedback {
      margin-top: 15px;
      font-size: 1.2em;
      height: 24px;
      min-height: 24px;
      user-select: none;
    }
    #explanation {
      margin-top: 10px;
      background: #FFF9C4;
      border: 2px dashed #FBC02D;
      padding: 12px;
      border-radius: 10px;
      max-width: 700px;
      display: none;
      font-size: 1.1em;
      user-select: none;
    }
    #score-bar {
      margin-top: 20px;
      width: 80%;
      background: #C8E6C9;
      border: 2px solid #66BB6A;
      border-radius: 12px;
      height: 20px;
      overflow: hidden;
    }
    #score-fill {
      height: 100%;
      width: 0%;
      background-color: #66BB6A;
      transition: width 0.5s ease;
    }
    #score {
      margin-top: 10px;
      font-size: 1.2em;
      user-select: none;
    }
    #badges {
      margin-top: 15px;
      font-size: 1.4em;
      user-select: none;
    }
    @media (max-width: 480px) {
      .answer {
        font-size: 1rem;
        padding: 10px 14px;
      }
      .diagram {
        width: 160px;
        height: 160px;
      }
      text {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>

  <h1>üéØ Geometry Tutor</h1>

  <div id="mascot">üòä</div>
  <div id="mascot-message">Hi! I'm Geo ü§ó ‚Äî your geometry guide!</div>

  <div id="question-box">Loading question...</div>
  <div class="diagram" id="diagram"></div>

  <div class="answers" id="answers"></div>

  <div id="feedback"></div>
  <div id="explanation"></div>

  <div id="score-bar"><div id="score-fill"></div></div>
  <div id="score">Score: 0</div>
  <div id="badges">Badges: ‚òÖ0</div>

  <script>
    (() => {
      const mascotEl = document.getElementById('mascot');
      const mascotMsg = document.getElementById('mascot-message');
      const questionBox = document.getElementById('question-box');
      const diagramDiv = document.getElementById('diagram');
      const answersDiv = document.getElementById('answers');
      const feedbackEl = document.getElementById('feedback');
      const explanationEl = document.getElementById('explanation');
      const scoreBarFill = document.getElementById('score-fill');
      const scoreEl = document.getElementById('score');
      const badgesEl = document.getElementById('badges');

      let score = 0;
      let badges = 0;

      const PI = 3.14;

      function randomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      // Create arrow marker defs for SVG once
      function createSvgDefs(svg) {
        if (svg.querySelector('defs')) return;
        const svgNS = "http://www.w3.org/2000/svg";
        const defs = document.createElementNS(svgNS, "defs");
        defs.innerHTML = `
          <marker id="arrow" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto" markerUnits="strokeWidth">
            <path d="M0,0 L0,6 L9,3 z" fill="#e91e63" />
          </marker>
        `;
        svg.appendChild(defs);
      }

      // Question types with working drawDiagram functions
      const questionTypes = [
        {
          type: 'Area of Square',
          generateQuestion: () => {
            const side = randomInt(3, 15);
            return {
              questionText: `Calculate the area of a square with side length <span style="color:#e91e63">${side}</span> units.`,
              correctAnswer: side * side,
              diagramData: { side },
              explanation: `Area of a square = side √ó side = ${side} √ó ${side} = ${side*side} square units.`,
              drawDiagram(svg, data) {
                const { side } = data;
                svg.innerHTML = `
                  <rect x="30" y="30" width="140" height="140" fill="#C8E6C9" stroke="#2E7D32" stroke-width="3" />
                  <line x1="30" y1="170" x2="170" y2="170" stroke="#e91e63" stroke-width="4" marker-end="url(#arrow)" />
                  <line x1="170" y1="170" x2="170" y2="30" stroke="#e91e63" stroke-width="4" marker-end="url(#arrow)" />
                  <text x="100" y="20" class="label-length" fill="#e91e63">Side = ${side}</text>
                  <text x="95" y="185" class="label-length" fill="#e91e63">${side}</text>
                  <text x="180" y="100" class="label-length" fill="#e91e63" transform="rotate(90 180,100)"> ${side} </text>
                `;
              }
            };
          }
        },
        {
          type: 'Perimeter of Rectangle',
          generateQuestion: () => {
            const length = randomInt(5, 20);
            const width = randomInt(3, 15);
            return {
              questionText: `Calculate the perimeter of a rectangle with length <span style="color:#e91e63">${length}</span> units and width <span style="color:#ff9800">${width}</span> units.`,
              correctAnswer: 2 * (length + width),
              diagramData: { length, width },
              explanation: `Perimeter = 2 √ó (length + width) = 2 √ó (${length} + ${width}) = ${2*(length+width)} units.`,
              drawDiagram(svg, data) {
                const { length, width } = data;
                svg.innerHTML = `
                  <rect x="40" y="50" width="${length*6}" height="${width*6}" fill="#FFF3E0" stroke="#F57C00" stroke-width="3" />
                  <line x1="40" y1="${50+width*6}" x2="${40+length*6}" y2="${50+width*6}" stroke="#e91e63" stroke-width="3" marker-end="url(#arrow)" />
                  <line x1="${40+length*6}" y1="${50+width*6}" x2="${40+length*6}" y2="50" stroke="#ff9800" stroke-width="3" marker-end="url(#arrow)" />
                  <text x="${40 + (length*6)/2 - 10}" y="${50 + width*6 + 20}" class="label-length">Length = ${length}</text>
                  <text x="${40 + length*6 + 5}" y="${50 + (width*6)/2 + 5}" class="label-width" transform="rotate(90, ${40 + length*6 + 5}, ${50 + (width*6)/2 + 5})">Width = ${width}</text>
                `;
              }
            };
          }
        },
        {
          type: 'Area of Circle',
          generateQuestion: () => {
            const radius = randomInt(2, 12);
            const area = Math.round(PI * radius * radius * 100) / 100; // 2 decimals
            return {
              questionText: `Calculate the area of a circle with radius <span style="color:#2196f3">${radius}</span> units. Use œÄ ‚âà 3.14.`,
              correctAnswer: area,
              diagramData: { radius },
              explanation: `Area = œÄ √ó radius¬≤ = 3.14 √ó ${radius}¬≤ = ${area} square units.`,
              drawDiagram(svg, data) {
                const { radius } = data;
                const rPixels = radius * 10;
                svg.innerHTML = `
                  <circle cx="120" cy="120" r="${rPixels}" fill="#BBDEFB" stroke="#1976D2" stroke-width="3"/>
                  <line x1="120" y1="120" x2="${120 + rPixels}" y2="120" stroke="#2196f3" stroke-width="3" marker-end="url(#arrow)" />
                  <text x="${120 + rPixels/2}" y="110" class="label-radius">Radius = ${radius}</text>
                `;
              }
            };
          }
        },
        {
          type: 'Missing angle in triangle',
          generateQuestion: () => {
            // angles a,b known, find c = 180-(a+b)
            const a = randomInt(30, 80);
            const b = randomInt(30, 80);
            const c = 180 - (a + b);
            if(c <= 0) return questionTypes[3].generateQuestion(); // regenerate if invalid
            return {
              questionText: `A triangle has angles <span style="color:#673ab7">${a}¬∞</span> and <span style="color:#673ab7">${b}¬∞</span>. Find the missing angle <span style="color:#673ab7">c</span>.`,
              correctAnswer: c,
              diagramData: { a, b, c },
              explanation: `Sum of angles in a triangle = 180¬∞. So, missing angle c = 180¬∞ - (${a}¬∞ + ${b}¬∞) = ${c}¬∞.`,
              drawDiagram(svg, data) {
                const { a, b, c } = data;
                svg.innerHTML = `
                  <polygon points="60,180 180,180 100,60" fill="#E1BEE7" stroke="#7B1FA2" stroke-width="3"/>
                  <text x="55" y="185" class="label-angle">a = ${a}¬∞</text>
                  <text x="185" y="185" class="label-angle">b = ${b}¬∞</text>
                  <text x="90" y="50" class="label-angle">c = ?</text>
                `;
              }
            };
          }
        }
      ];

      let currentQuestion = null;
      let allowAnswer = true;

      function setMascotMessage(msg, emoji = 'üòä') {
        mascotMsg.textContent = msg;
        mascotEl.textContent = emoji;
      }

      function speak(text) {
        if (!('speechSynthesis' in window)) return;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        window.speechSynthesis.cancel(); // cancel ongoing
        window.speechSynthesis.speak(utterance);
      }

      function updateScore(delta) {
        score += delta;
        if(score < 0) score = 0;
        scoreEl.textContent = `Score: ${score}`;
        // update progress bar (max 200 for scaling)
        const widthPercent = Math.min(100, (score / 200) * 100);
        scoreBarFill.style.width = widthPercent + '%';

        // badges every 50 points
        const newBadges = Math.floor(score / 50);
        if(newBadges > badges){
          badges = newBadges;
          badgesEl.textContent = `Badges: ${'‚òÖ'.repeat(badges)}${badges}`;
          setMascotMessage(`You earned a badge! ${'‚òÖ'.repeat(badges)}`, 'üèÖ');
          speak(`Congratulations! You earned a badge!`);
        }
      }

      // Shuffle array
      function shuffleArray(arr) {
        for(let i = arr.length - 1; i > 0; i--){
          const j = Math.floor(Math.random() * (i +1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      function createAnswerButtons(correct, allAnswers) {
        answersDiv.innerHTML = '';
        allAnswers.forEach(ans => {
          const btn = document.createElement('button');
          btn.className = 'answer';
          btn.textContent = ans;
          btn.onclick = () => {
            if(!allowAnswer) return;
            allowAnswer = false;
            if(ans === correct){
              btn.classList.add('correct');
              feedbackEl.textContent = 'Correct! üéâ';
              feedbackEl.style.color = '#388E3C';
              explanationEl.style.display = 'block';
              explanationEl.textContent = currentQuestion.explanation;
              setMascotMessage('Great job! You got it right! üéâ', 'üòÑ');
              speak('Correct! ' + currentQuestion.explanation);
              updateScore(10);
              setTimeout(loadNextQuestion, 3500);
            } else {
              btn.classList.add('wrong');
              feedbackEl.textContent = 'Oops! Try again. ‚ùå';
              feedbackEl.style.color = '#D32F2F';
              setMascotMessage('Keep trying! You can do it! üí™', 'ü§î');
              updateScore(-5);
              speak('Incorrect. Try again.');
              allowAnswer = true;
            }
          };
          answersDiv.appendChild(btn);
        });
      }

      function generateOptions(correct) {
        // Generate close wrong answers near correct
        let options = [correct];
        while(options.length < 4){
          let offset = randomInt(-5,5);
          if(offset === 0) continue;
          let val = Math.round(correct + offset);
          if(val < 0) val = Math.abs(val) + 2;
          if(!options.includes(val)){
            options.push(val);
          }
        }
        return shuffleArray(options);
      }

      function loadNextQuestion() {
        feedbackEl.textContent = '';
        explanationEl.style.display = 'none';

        // Pick random question type
        let qType = questionTypes[randomInt(0, questionTypes.length -1)];
        currentQuestion = qType.generateQuestion();

        questionBox.innerHTML = currentQuestion.questionText;

        // Create SVG diagram
        diagramDiv.innerHTML = '';
        const svgNS = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(svgNS, 'svg');
        svg.setAttribute('viewBox', '0 0 240 240');
        createSvgDefs(svg);
        diagramDiv.appendChild(svg);

        currentQuestion.drawDiagram(svg, currentQuestion.diagramData);

        // Create answers buttons
        let options = generateOptions(currentQuestion.correctAnswer);
        createAnswerButtons(currentQuestion.correctAnswer, options);

        allowAnswer = true;
        setMascotMessage('Try to answer!');
      }

      // Start game
      updateScore(0);
      loadNextQuestion();

    })();
  </script>

</body>
</html>
